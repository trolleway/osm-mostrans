<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    
    <link rel="stylesheet" href="https://openlayers.org/en/v3.18.2/css/ol.css" type="text/css">
     <script src="https://openlayers.org/en/v3.18.2/build/ol.js" type="text/javascript"></script>
     
     <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
     

    <title>Osm-mostrans by trolleway</title>
    <meta name = "description" content = "Автоматически обновляемая веб-карта московского транспорта из данных Openstreetmap, с конечными и направлениями движения." />
   <meta name = "author" content = "trolleway">
   
       <style>
      .map {
        /*width: 100%;*/
        }
      .map:-moz-full-screen {
        height: 100%;
      }
      .map:-webkit-full-screen {
        height: 100%;
      }
      .map:-ms-fullscreen {
        height: 100%;
      }
      .map:fullscreen {
        height: 100%;
      }
      .ol-rotate {
        top: 3em;
      }
    </style>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Osm-mostrans</h1>
        <h2>Карта городского транспорта Москвы по данным OpenStreetMap</h2>

        <section id="downloads">
          <!--<a href="https://github.com/trolleway/osm-mostrans/zipball/master" class="btn">Download as .zip</a>-->
          <!--<a href="https://github.com/trolleway/osm-mostrans/tarball/master" class="btn">Download as .tar.gz</a>-->
          <a href="https://github.com/trolleway/osm-mostrans" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
          <a href="http://nextgis.ru"><img src="http://nextgis.com/wp-content/themes/nextgis_clean/img/logo.svg" width="200"></a>
          <a href="https://wiki.openstreetmap.org/wiki/RU:%D0%97%D0%B0%D0%B3%D0%BB%D0%B0%D0%B2%D0%BD%D0%B0%D1%8F_%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0">
            <img src="https://wiki.openstreetmap.org/w/images/thumb/b/b0/Openstreetmap_logo.svg/100px-Openstreetmap_logo.svg.png" width="100"></a>
          
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <!--
        <h3>
<a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Welcome to GitHub Pages.</h3>
        -->
    <h3>Дежурная карта</h3> 
        <form>
          <fieldset>
            <label id="layer_tram"><input type="radio" id="layer_tram" name="layer"/>Трамвай </label>
            <label id="layer_trolleybus"><input type="radio" id="layer_trolleybus" name="layer" />Троллейбус</label>
            <label id="layer_bus"><input type="radio" id="layer_bus" name="layer" checked />Автобус</label>
            <label id="layer_frequent"><input type="radio" id="layer_frequent" name="layer" />Частоходящие и магистральные маршруты</label>
            <label id="layer_osoc"><input type="radio" id="layer_osoc" name="layer" />Осоциаленные маршрутки</label>
            <label id="layer_night"><input type="radio" id="layer_night" name="layer" />Ночные маршруты</label>
           </fieldset>
       </form>
        <!--
        <a href=# id="layer_tram">Трамвай</a>
        <a href=# id="layer_trolleybus">Троллейбус</a>
        <a href=# id="layer_bus">Автобус</a>
        <a href=# id="layer_osoc">Осоциаленные маршрутки</a>
        <a href=# id="layer_frequent">Частоходящие и магистральные маршруты</a>
        <a href=# id="layer_night">Ночные маршруты</a>
        -->
    <div id="map" class="map" ></div>

 <table class="controls" style="display:none;"> <!-- Максимально быстрая переделка семпла из документации под мой стиль -->
  <tr>
    <td>hue</td>
    <td><span id="hueOut"></span>°</td>
    <td><input id="hue" type="range" min="-180" max="180" value="0"/></td>
  </tr>
  <tr>
    <td>chroma</td>
    <td><span id="chromaOut"></span> %</td>
    <td><input id="chroma" type="range" min="0" max="100" value="0"/></td>
  </tr>
  <tr>
    <td>lightness</td>
    <td><span id="lightnessOut"></span> %</td>
    <td><input id="lightness" type="range" min="0" max="100" value="60"/></td>
  </tr>
</table>


<br />
    <script type="text/javascript">
/**
 * Color manipulation functions below are adapted from
 * https://github.com/d3/d3-color.
 */
var Xn = 0.950470;
var Yn = 1;
var Zn = 1.088830;
var t0 = 4 / 29;
var t1 = 6 / 29;
var t2 = 3 * t1 * t1;
var t3 = t1 * t1 * t1;
var twoPi = 2 * Math.PI;


/**
 * Convert an RGB pixel into an HCL pixel.
 * @param {Array.<number>} pixel A pixel in RGB space.
 * @return {Array.<number>} A pixel in HCL space.
 */
function rgb2hcl(pixel) {
  var red = rgb2xyz(pixel[0]);
  var green = rgb2xyz(pixel[1]);
  var blue = rgb2xyz(pixel[2]);

  var x = xyz2lab(
      (0.4124564 * red + 0.3575761 * green + 0.1804375 * blue) / Xn);
  var y = xyz2lab(
      (0.2126729 * red + 0.7151522 * green + 0.0721750 * blue) / Yn);
  var z = xyz2lab(
      (0.0193339 * red + 0.1191920 * green + 0.9503041 * blue) / Zn);

  var l = 116 * y - 16;
  var a = 500 * (x - y);
  var b = 200 * (y - z);

  var c = Math.sqrt(a * a + b * b);
  var h = Math.atan2(b, a);
  if (h < 0) {
    h += twoPi;
  }

  pixel[0] = h;
  pixel[1] = c;
  pixel[2] = l;

  return pixel;
}


/**
 * Convert an HCL pixel into an RGB pixel.
 * @param {Array.<number>} pixel A pixel in HCL space.
 * @return {Array.<number>} A pixel in RGB space.
 */
function hcl2rgb(pixel) {
  var h = pixel[0];
  var c = pixel[1];
  var l = pixel[2];

  var a = Math.cos(h) * c;
  var b = Math.sin(h) * c;

  var y = (l + 16) / 116;
  var x = isNaN(a) ? y : y + a / 500;
  var z = isNaN(b) ? y : y - b / 200;

  y = Yn * lab2xyz(y);
  x = Xn * lab2xyz(x);
  z = Zn * lab2xyz(z);

  pixel[0] = xyz2rgb(3.2404542 * x - 1.5371385 * y - 0.4985314 * z);
  pixel[1] = xyz2rgb(-0.9692660 * x + 1.8760108 * y + 0.0415560 * z);
  pixel[2] = xyz2rgb(0.0556434 * x - 0.2040259 * y + 1.0572252 * z);

  return pixel;
}

function xyz2lab(t) {
  return t > t3 ? Math.pow(t, 1 / 3) : t / t2 + t0;
}

function lab2xyz(t) {
  return t > t1 ? t * t * t : t2 * (t - t0);
}

function rgb2xyz(x) {
  return (x /= 255) <= 0.04045 ? x / 12.92 : Math.pow((x + 0.055) / 1.055, 2.4);
}

function xyz2rgb(x) {
  return 255 * (x <= 0.0031308 ?
      12.92 * x : 1.055 * Math.pow(x, 1 / 2.4) - 0.055);
}

function rgb2invert(pixel) {

  pixel[0] = 255-pixel[0];
  pixel[1] = 255-pixel[1];
  pixel[2] = 255-pixel[2];

  return pixel;
  
}

var raster = new ol.source.Raster({
  sources: [new ol.source.OSM()],
  operation: function(pixels, data) {
  
    
    pixelsInverted=rgb2invert(pixels[0]);
    var hcl = rgb2hcl(pixelsInverted);

    var h = hcl[0] + Math.PI * data.hue / 180;
    if (h < 0) {
      h += twoPi;
    } else if (h > twoPi) {
      h -= twoPi;
    }
    hcl[0] = h;

    hcl[1] *= (data.chroma / 100);
    hcl[2] *= (data.lightness / 100);

    return hcl2rgb(hcl);
    
  },
  lib: {
  	rgb2invert: rgb2invert,
    rgb2hcl: rgb2hcl,
    hcl2rgb: hcl2rgb,
    rgb2xyz: rgb2xyz,
    lab2xyz: lab2xyz,
    xyz2lab: xyz2lab,
    xyz2rgb: xyz2rgb,
    Xn: Xn,
    Yn: Yn,
    Zn: Zn,
    t0: t0,
    t1: t1,
    t2: t2,
    t3: t3,
    twoPi: twoPi
  }
});

var controls = {};

raster.on('beforeoperations', function(event) {
  var data = event.data;
  for (var id in controls) {
    data[id] = Number(controls[id].value);
  }
});

var layer_bus=new ol.layer.Tile({
            source: new ol.source.XYZ({
              attributions: [new ol.Attribution({
        html: 'Tiles cc-by-sa trolleway, data: Openstreetmap, hosting: NextGIS'
      })],
              url: 'http://trolleway.nextgis.com/api/component/render/tile?z={z}&x={x}&y={y}&resource=650,654'
            , isBaseLayer: true})
          });
var layer_osoc=new ol.layer.Tile({
            source: new ol.source.XYZ({
              attributions: [new ol.Attribution({
        html: 'Tiles cc-by-sa trolleway, data: Openstreetmap, hosting: NextGIS'
      })],
              url: 'http://trolleway.nextgis.com/api/component/render/tile?z={z}&x={x}&y={y}&resource=102,101'
            , isBaseLayer: true})
          });
      
var layer_tram=new ol.layer.Tile({
            source: new ol.source.XYZ({
              attributions: [new ol.Attribution({
        html: 'Tiles cc-by-sa trolleway, data: Openstreetmap, hosting: NextGIS'
      })],
              url: 'http://trolleway.nextgis.com/api/component/render/tile?z={z}&x={x}&y={y}&resource=678,679'
            , isBaseLayer: true})
          });
      
var layer_trolleybus=new ol.layer.Tile({
            source: new ol.source.XYZ({
              attributions: [new ol.Attribution({
        html: 'Tiles cc-by-sa trolleway, data: Openstreetmap, hosting: NextGIS'
      })],
              url: 'http://trolleway.nextgis.com/api/component/render/tile?z={z}&x={x}&y={y}&resource=687,689'
            , isBaseLayer: true})
          });
      
var layer_frequent=new ol.layer.Tile({
            source: new ol.source.XYZ({
              attributions: [new ol.Attribution({
        html: 'Tiles cc-by-sa trolleway, data: Openstreetmap, hosting: NextGIS'
      })],
              url: 'http://trolleway.nextgis.com/api/component/render/tile?z={z}&x={x}&y={y}&resource=711,713'
            , isBaseLayer: true})
          });     
            
var layer_night=new ol.layer.Tile({
            source: new ol.source.XYZ({
              attributions: [new ol.Attribution({
        html: 'Tiles cc-by-sa trolleway, data: Openstreetmap, hosting: NextGIS'
      })],
              url: 'http://trolleway.nextgis.com/api/component/render/tile?z={z}&x={x}&y={y}&resource=706,707'
            , isBaseLayer: true})
          });  
var map = new ol.Map({
  layers: [
    new ol.layer.Image({source: raster}),
  ],
  controls: ol.control.defaults().extend([new ol.control.FullScreen() ]),
  target: 'map',
  view: new ol.View({
          center: ol.proj.fromLonLat([37.6316, 55.7188]),
          zoom: 13
  })
});

map.addLayer(layer_bus);

/* basemap rasert operation controls*/
var controlIds = ['hue', 'chroma', 'lightness'];
controlIds.forEach(function(id) {
  var control = document.getElementById(id);
  var output = document.getElementById(id + 'Out');
  control.addEventListener('input', function() {
    output.innerText = control.value;
    raster.changed();
  });
  output.innerText = control.value;
  controls[id] = control;
});



$(document).ready(function() {

  function removeNamedLayers(map) {
    map.removeLayer(layer_bus);
    map.removeLayer(layer_osoc);
    map.removeLayer(layer_tram);
    map.removeLayer(layer_trolleybus);
    map.removeLayer(layer_frequent);
    map.removeLayer(layer_night);
  }
  $('#layer_bus').on('click', function() {
    removeNamedLayers(map);
    map.addLayer(layer_bus);
  });

  $('#layer_osoc').on('click', function() {
    removeNamedLayers(map);
    map.addLayer(layer_osoc);
  });
  
  $('#layer_tram').on('click', function() {
    removeNamedLayers(map);
    map.addLayer(layer_tram);
  });
    
  $('#layer_trolleybus').on('click', function() {
    removeNamedLayers(map);
    map.addLayer(layer_trolleybus);
  });
      
  $('#layer_frequent').on('click', function() {
    removeNamedLayers(map);
    map.addLayer(layer_frequent);
  });
      
  $('#layer_night').on('click', function() {
    removeNamedLayers(map);
    map.addLayer(layer_night);
  });
});
            
    </script>
<p>
На этой странице показываются выгрузки маршрутов НОТ по Московскому региону из Openstreetmap. Обновление - каждые 2 часа. 
        </p>
        <h3>Описания слоёв</h3>        
<ul style="list-style-type:square">
<li>Автобус - показаны только route=bus, полностью проходящие внутри полигона [<a href="https://github.com/trolleway/osm-mostrans/blob/master/cfg/mostrans-bus_red_zone.geojson">></a>]</li>
<li>Троллейбус - гибнет  </li>  
<li>Трамвай</li>
<li>Осоциаленные маршрутки - набор маршрутов, который не имеет понятного официального названия, попробую объяснить. 
  В 2016 году маршрутки поотменяли, вместо них по новым маршрутам пустили автобусы и микроавтобусы частников, 
  принимающих общие билеты. Это - новые маршруты, которые теперь стали доступны людям с проездными.
  Показаны маршруты route=bus, payment:troika=yes, из списка https://github.com/trolleway/osm-mostrans/blob/master/cfg/moscow_newmodel_bus_routes_2016.json
<li>Ночные маршруты - показаны маршруты всех видов транспорта из списка https://github.com/trolleway/osm-mostrans/blob/master/cfg/mostrans_night.json
  Ещё туда влезает автобусный маршрут в Железнодорожном, его я не придумал как удалить
</li> 
</ul>  
  
<h3>Техническая реализация</h3>    
  <p>В репозитории находится скрипт, который регулярно генерирует карты городского транспорта Москвы по данным Openstreetmap. 
  Данные в нём неполные, но одна из задач этой странички - сделать так, что бы люди правили эти данные. </p>
 <p>Скрипт работает на digitalocean, и отправляет данные на сервис nextgis.com, который занимается хранением геоданных, 
  и рендерингом веб-карты.</p> 
Базовая карта на этой странице - OSM Mapnik, которая перекрашивается в OpenLayers3 на клиенте: https://jsfiddle.net/trolleway/76yee6uc/

<p>Вы можете развернуть рендеринг на своём сервере, задав координаты своего города или региона. </p>

<h5>
<a id="Редактировать маршруты" class="anchor"  aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>
  Редактировать маршруты</h5>

        <p>Данные автоматически обновляются каждый день из свежей базы Openstreetmap. <a href="https://trolleway.github.io/vvod_marshutov_OT_openstreetmap">Правьте маршруты в ней</a></p>
        
<h3>
<a id="Другие-варианты-использования" class="anchor" href="#%D0%94%D1%80%D1%83%D0%B3%D0%B8%D0%B5-%D0%B2%D0%B0%D1%80%D0%B8%D0%B0%D0%BD%D1%82%D1%8B-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Другие варианты использования</h3>

<h5>
<a id="Мобильное-приложение" class="anchor" href="#%D0%9C%D0%BE%D0%B1%D0%B8%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Мобильное приложение</h5>

<p>Загрузите <a href="https://play.google.com/store/apps/details?id=com.nextgis.mobile">NextGIS Mobile в Play Market</a>, добавьте слой из NextGIS с сервера trolleway.nextgis.com с автобусной картой</p>

<h5>
<a id="Использование-карты-маршрутов-в-вашей-ГИС" class="anchor" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%B0%D1%80%D1%82%D1%8B-%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%BE%D0%B2-%D0%B2-%D0%B2%D0%B0%D1%88%D0%B5%D0%B9-%D0%93%D0%98%D0%A1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Использование карты маршрутов в вашей ГИС</h5>

<p>У нас есть WMS-сервис. Можно верстать карту в QGIS. Подключайтесь по протоколу WMS по адресу <a href="http://trolleway.nextgis.com/api/resource/104/wms">http://trolleway.nextgis.com/api/resource/104/wms</a></p>
      </section>
    </div>

    
  </body>
</html>
